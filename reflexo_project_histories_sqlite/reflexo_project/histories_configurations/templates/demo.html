<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pacientes ‚Äî {{ request.tenant.name|default:"Demo" }}</title>
<link rel="stylesheet" href="{% load static %}{% static 'css/styles.css' %}">
</head>
<body>

<!-- Header con informaci√≥n del tenant -->
<div class="tenant-header" style="background: #2c3e50; color: white; padding: 15px 20px; text-align: center; border-bottom: 3px solid #3498db;">
    <h1 style="margin: 0; font-size: 1.5rem;">üè• {{ request.tenant.name|default:"Sistema Demo" }}</h1>
    <p style="margin: 5px 0 0 0; opacity: 0.8; font-size: 0.9rem;">{{ request.tenant.description|default:"Sistema de Historias Cl√≠nicas" }}</p>
    <a href="/" style="color: #3498db; text-decoration: none; font-size: 0.8rem; display: inline-block; margin-top: 10px;">‚Üê Cambiar Cl√≠nica</a>
</div>

<!-- Navigation Menu -->
<nav class="nav-menu">
  <ul>
    <li><a href="#" class="nav-link active" data-tab="historias">Historias</a></li>
    <li><a href="#" class="nav-link" data-tab="configuraciones">Configuraciones</a></li>
  </ul>
</nav>

<!-- Historias Tab Content -->
<div id="historias" class="tab-content active">
  <h1>Lista de Pacientes</h1>

  <div class="topbar">
    <button class="btn btn-create" onclick="openPatientModal('create')">Crear Historial</button>
    <input id="searchInput" class="search" placeholder="Buscar por Apellido/Nombre o DNI..." oninput="onSearch()" />
  </div>

  <div class="panel">
    <table>
      <thead>
        <tr>
          <th class="col-doc">Nro. Documento</th>
          <th class="col-name">Apellido ; Nombre</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- rows din√°micos -->
      </tbody>
    </table>

    <div class="footer-bar">
      <div class="page-info" id="pageInfo">0 registros</div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="pages" id="pagination"></div>
        <div style="width:12px"></div>
        <div style="min-width:80px;text-align:right;color:#9c9c9c"> <span id="pageSizeLabel">10</span> / p√°gina</div>
      </div>
    </div>
  </div>
</div>

<!-- Configuraciones Tab Content -->
<div id="configuraciones" class="tab-content">
  <h1>Configuraciones del Sistema</h1>
  
  <!-- Tipos de Documento -->
  <div class="config-section">
    <div class="section-header">
      <h2>Tipos de Documento</h2>
      <button class="btn btn-create" onclick="openConfigModal('document_type', 'create')">Agregar Tipo</button>
    </div>
    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="documentTypesTable">
          <!-- Document types will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tipos de Pago -->
  <div class="config-section">
    <div class="section-header">
      <h2>Tipos de Pago</h2>
      <button class="btn btn-create" onclick="openConfigModal('payment_type', 'create')">Agregar Tipo</button>
    </div>
    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="paymentTypesTable">
          <!-- Payment types will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagos Predeterminados -->
  <div class="config-section">
    <div class="section-header">
      <h2>Pagos Predeterminados</h2>
      <button class="btn btn-create" onclick="openConfigModal('predetermined_payment', 'create')">Agregar Pago</button>
    </div>
    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>Descripci√≥n</th>
            <th>Monto (S/)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="predeterminedPricesTable">
          <!-- Default payments will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal paciente (crear/editar) -->
<div class="modal" id="patientModal" onclick="modalOutsideClick(event,'patientModal')">
  <div class="modal-card" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <h3 id="patientModalTitle">Detalles del Paciente</h3>
    <form id="patientForm" onsubmit="event.preventDefault(); savePatient();">
      <div class="grid-2">
        <div>
          <label>Nro Documento</label>
          <input id="f_document_number" type="text" required />
        </div>
        <div>
          <label>Tipo Documento</label>
          <select id="f_document_type" required>
            <option value="">Seleccionar...</option>
            <!-- Document types will be loaded here -->
          </select>
        </div>

        <div style="grid-column:1 / -1">
          <label>Apellido y Nombre</label>
          <input id="f_full_name" type="text" required />
        </div>

        <div>
          <label>Talla (m)</label>
          <input id="f_height" type="number" step="0.01" placeholder="ej. 1.75" />
        </div>
        <div>
          <label>Peso (kg)</label>
          <input id="f_weight" type="number" step="0.01" placeholder="ej. 70.5" />
        </div>

        <div>
          <label>Tipo de Pago</label>
          <select id="f_payment_type">
            <option value="">Seleccionar...</option>
            <!-- Payment types will be loaded here -->
          </select>
        </div>
        <div>
          <label>Opciones de Pago</label>
          <select id="f_payment_option" onchange="updateAmountFromOption()">
            <option value="">Seleccionar opci√≥n...</option>
            <!-- Default payment options will be loaded here -->
          </select>
        </div>
        <div>
          <label>Monto (S/)</label>
          <input id="f_amount" type="number" step="0.01" placeholder="ej. 50.00" />
        </div>

        <div style="grid-column:1 / -1">
          <label>Observaci√≥n</label>
          <textarea id="f_observation" placeholder="Observaciones adicionales..."></textarea>
        </div>

        <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" class="btn-ghost" onclick="closeModal('patientModal')">Cancelar</button>
          <button type="submit" class="btn-save">Guardar Cambios</button>
        </div>
      </div>
      <input type="hidden" id="f_id" />
    </form>
  </div>
</div>

<!-- Modal de Configuraci√≥n -->
<div class="modal" id="configModal" onclick="modalOutsideClick(event,'configModal')">
  <div class="modal-card" onclick="event.stopPropagation()">
    <h3 id="configModalTitle">Configuraci√≥n</h3>
    <form id="configForm" onsubmit="event.preventDefault(); saveConfig();">
      <div class="grid-2">
        <div>
          <label>Nombre</label>
          <input id="config_name" type="text" required oninput="validateTextInput(this)" />
        </div>
        <div>
          <label>Descripci√≥n</label>
          <input id="config_description" type="text" oninput="validateTextInput(this)" />
        </div>
        <div id="amountField" style="display:none;">
          <label>Monto (S/)</label>
          <input id="config_amount" type="number" step="0.01" placeholder="ej. 50.00" oninput="validateNumberInput(this)" />
        </div>
        <div id="paymentTypeField" style="display:none;">
          <label>Tipo de Pago</label>
          <select id="config_payment_type">
            <option value="">Seleccionar...</option>
            <!-- Payment types will be loaded here -->
          </select>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-ghost" onclick="closeModal('configModal')">Cancelar</button>
        <button type="submit" class="btn-save">Guardar</button>
      </div>
      
      <input type="hidden" id="config_id" />
      <input type="hidden" id="config_type" />
    </form>
  </div>
</div>

<!-- Modal historial (ver/agregar entradas) -->
<div class="modal" id="historyModal" onclick="modalOutsideClick(event,'historyModal')">
  <div class="modal-card" onclick="event.stopPropagation()">
    <h3>Detalles del Historial</h3>
    <div id="historyPatientName" style="margin-bottom:10px; font-weight:700; color:#ddd;"></div>

    <form id="historyForm" onsubmit="event.preventDefault(); saveHistoryEntry()">
      <div class="grid-2">
        <div>
          <label>Fecha de la Cita</label>
          <input id="h_date" type="date" required />
        </div>
        <div>
          <label>Terapeuta</label>
          <input id="h_therapist" type="text" placeholder="Nombre terapeuta" />
        </div>

        <div>
          <label>Diagn√≥sticos m√©dicos</label>
          <textarea id="h_diagnosis"></textarea>
        </div>
        <div>
          <label>Dolencias</label>
          <textarea id="h_ailments"></textarea>
        </div>

        <div>
          <label>Medicamentos</label>
          <textarea id="h_medications"></textarea>
        </div>
        <div>
          <label>Observaciones</label>
          <textarea id="h_observations"></textarea>
        </div>

        <div>
          <label>Talla (m)</label>
          <input id="h_height" type="number" step="0.01" />
        </div>
        <div>
          <label>Peso (kg)</label>
          <input id="h_weight" type="number" step="0.01" />
        </div>

        <div>
          <label>Testimonio</label>
          <select id="h_testimony">
            <option value="No">No</option>
            <option value="Si">S√≠</option>
          </select>
        </div>

        <div>
          <label>Tipo de Pago</label>
          <select id="h_payment_type">
            <option value="">Seleccionar...</option>
            <!-- Payment types will be loaded here -->
          </select>
        </div>

        <div style="grid-column:1 / -1">
          <label>Diagn√≥sticos de Reflexolog√≠a</label>
          <textarea id="h_reflex"></textarea>
        </div>

        <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" class="btn-ghost" onclick="closeModal('historyModal')">Cerrar</button>
          <button type="submit" class="btn-save">Guardar Cambios</button>
        </div>
      </div>
    </form>

    <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.04);margin:14px 0;">
    <div>
      <h4 style="color:var(--accent); margin:6px 0 8px">Entradas Previas</h4>
      <div id="historyList" style="max-height:220px; overflow:auto; padding-right:6px;"></div>
    </div>
  </div>
</div>

<script>
/* -----------------------------
   Datos de ejemplo (cliente)
   Reemplaza con llamadas fetch a tu API
   - apiList() -> GET /histories/
   - apiCreate(payload) -> POST /histories/create/
   - apiUpdate(id, payload) -> PUT /histories/{id}/
   - apiDelete(id) -> POST /histories/delete/{id}/
   ----------------------------- */

let patients = [
  { id: 1, document_type: "DNI", document_number: "95352741", full_name: "GONZALEZ PEREZ SEBASTIAN GABRIEL", height:1.75, weight:78, payment_type:"Yape", amount:50, observation:"", histories:[], deleted_at:null, created_at: "2025-08-16" },
  { id: 2, document_type: "DNI", document_number: "46952396", full_name: "HIERRO SANCHEZ JUAN ANGEL", height:1.72, weight:70, payment_type:"Efectivo", amount:60, observation:"", histories:[], deleted_at:null, created_at: "2025-07-20" },
  { id: 3, document_type: "CE", document_number: "61102045", full_name: "ESPINOZA CALDERON DIEGO ANDRE", height:1.65, weight:65, payment_type:"Plin", amount:55, observation:"", histories:[], deleted_at:null, created_at: "2025-06-11" },
  { id: 4, document_type: "DNI", document_number: "75759333", full_name: "BRUNO LOPEZ LUIS", height:1.78, weight:82, payment_type:"Transferencia", amount:70, observation:"", histories:[], deleted_at:null, created_at: "2025-05-02" },
  { id: 5, document_type: "DNI", document_number: "70529703", full_name: "MORALESQUIR QUIROZOW JANET CAROLQWR", height:1.60, weight:59, payment_type:"Yape", amount:45, observation:"", histories:[], deleted_at:null, created_at: "2025-04-09" },
  { id: 6, document_type: "Pasaporte", document_number: "78415256", full_name: "CHAMO MILOCO JAIME", height:1.82, weight:90, payment_type:"Efectivo", amount:65, observation:"", histories:[], deleted_at:null, created_at: "2025-03-22" },
  { id: 7, document_type: "DNI", document_number: "78451265", full_name: "COMEREGIMENEZ MARIA", height:1.55, weight:58, payment_type:"Plin", amount:50, observation:"", histories:[], deleted_at:null, created_at: "2025-02-08" },
  { id: 8, document_type: "DNI", document_number: "84751253", full_name: "QUIJSPEQUIROZ MARIA", height:1.59, weight:54, payment_type:"Yape", amount:40, observation:"", histories:[], deleted_at:null, created_at: "2025-01-30" },
  { id: 9, document_type: "DNI", document_number: "2222222", full_name: "MAMAMUSUS PIO JULIAN", height:1.70, weight:75, payment_type:"Efectivo", amount:55, observation:"", histories:[], deleted_at:null, created_at: "2024-11-12" },
  { id: 10, document_type: "RUC", document_number: "87654321", full_name: "CHAPONAN DIEZ PEPE", height:1.68, weight:67, payment_type:"Tarjeta", amount:80, observation:"", histories:[], deleted_at:null, created_at: "2024-10-01" },
];

let state = {
  query: "",
  page: 1,
  pageSize: 10
};

async function apiList() {
  try {
    const response = await fetch('/histories_configurations/histories/');
    if (!response.ok) throw new Error('Error al cargar historiales');
    const data = await response.json();
    return data.histories || [];
  } catch (error) {
    console.error('Error API:', error);
    // Fallback a datos locales si la API falla
    return patients.filter(p=>!p.deleted_at);
  }
}

async function apiCreate(payload) {
  try {
    const response = await fetch('/histories_configurations/histories/create/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al crear historial');
    }
    
    const newItem = await response.json();
    // Agregar a la lista local para mantener sincronizaci√≥n
    patients.unshift({ ...newItem, histories: [], deleted_at: null });
    return newItem;
  } catch (error) {
    console.error('Error API:', error);
    alert(error.message);
    // Fallback a creaci√≥n local
    const id = Date.now();
    const newItem = { id, ...payload, histories:[], deleted_at:null, created_at: new Date().toISOString().slice(0,10) };
    patients.unshift(newItem);
    return Promise.resolve(newItem);
  }
}

async function apiUpdate(id, payload) {
  try {
    const response = await fetch(`/histories_configurations/histories/${id}/update/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al actualizar historial');
    }
    
    const updatedItem = await response.json();
    // Actualizar en la lista local
    const idx = patients.findIndex(p=>p.id===id);
    if(idx>=0) patients[idx] = {...patients[idx], ...updatedItem};
    return updatedItem;
  } catch (error) {
    console.error('Error API:', error);
    alert(error.message);
    // Fallback a actualizaci√≥n local
    const idx = patients.findIndex(p=>p.id===id);
    if(idx>=0) patients[idx] = {...patients[idx], ...payload};
    return Promise.resolve(patients[idx]);
  }
}

async function apiDelete(id) {
  try {
    const response = await fetch(`/histories_configurations/histories/${id}/delete/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al eliminar historial');
    }
    
    // Soft delete en la lista local
    const p = patients.find(x=>x.id===id);
    if(p) p.deleted_at = new Date().toISOString();
    return {status:'deleted'};
  } catch (error) {
    console.error('Error API:', error);
    alert(error.message);
    // Fallback a eliminaci√≥n local
    const p = patients.find(x=>x.id===id);
    if(p) p.deleted_at = new Date().toISOString();
    return Promise.resolve({status:'deleted'});
  }
}

/* ---------- Render tabla y paginaci√≥n ---------- */
async function render() {
  const all = await apiList();
  const q = state.query.trim().toLowerCase();
  const filtered = all.filter(p => {
    return p.document_number.toLowerCase().includes(q) || p.full_name.toLowerCase().includes(q);
  });

  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / state.pageSize));
  if(state.page > pages) state.page = pages;

  const start = (state.page - 1) * state.pageSize;
  const visible = filtered.slice(start, start + state.pageSize);

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  if(visible.length===0){
    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;color:#9a9a9a">No hay historiales</td></tr>`;
  } else {
    visible.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="col-doc">${escapeHtml(p.document_number)}</td>
        <td class="col-name">${escapeHtml(p.full_name)}</td>
        <td class="actions">
          <button class="small-btn edit" onclick="openPatientModal('edit', ${p.id})">Editar</button>
          <button class="small-btn info" onclick="openInfo(${p.id})">M√°s Info</button>
          <button class="small-btn history" onclick="openHistory(${p.id})">Historia</button>
          <button class="small-btn delete" onclick="deletePatient(${p.id})">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // paginaci√≥n
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';

  const createPageBtn = (n, text = null) => {
    const el = document.createElement('div');
    el.className = 'page' + (n===state.page ? ' active' : '');
    el.textContent = text || n;
    el.onclick = () => { state.page = n; render(); };
    return el;
  };

  // Prev
  const prev = document.createElement('div');
  prev.className='page';
  prev.textContent = '<';
  prev.onclick = ()=>{ if(state.page>1) { state.page--; render(); } };
  pagination.appendChild(prev);

  // numeric pages: show window
  const windowSize = 5;
  let startPage = Math.max(1, state.page - Math.floor(windowSize/2));
  let endPage = Math.min(pages, startPage + windowSize -1);
  startPage = Math.max(1, endPage - windowSize +1);

  for(let i=startPage;i<=endPage;i++){
    pagination.appendChild(createPageBtn(i));
  }

  // Next
  const next = document.createElement('div');
  next.className='page';
  next.textContent = '>';
  next.onclick = ()=>{ if(state.page<pages) { state.page++; render(); } };
  pagination.appendChild(next);

  // page info
  document.getElementById('pageInfo').textContent = `${total} registros`;
  document.getElementById('pageSizeLabel').textContent = state.pageSize;
}

/* ---------- Buscador ---------- */
function onSearch(){
  state.query = document.getElementById('searchInput').value;
  state.page = 1;
  render();
}

/* ---------- Modal helpers ---------- */
function openModalId(id) {
  document.getElementById(id).classList.add('show');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}
function modalOutsideClick(ev, id){
  if(ev.target.id === id) closeModal(id);
}

/* ---------- CRUD UI ---------- */
function openPatientModal(mode, id=null) {
  const title = document.getElementById('patientModalTitle');
  const form = document.getElementById('patientForm');
  document.getElementById('f_id').value = '';
  document.getElementById('f_document_number').value = '';
  document.getElementById('f_document_type').value = '';
  document.getElementById('f_full_name').value = '';
  document.getElementById('f_height').value = '';
  document.getElementById('f_weight').value = '';
  document.getElementById('f_payment_type').value = '';
  document.getElementById('f_payment_option').value = '';
  document.getElementById('f_amount').value = '';
  document.getElementById('f_observation').value = '';

  if(mode==='create'){
    title.textContent = 'Crear Paciente';
  } else {
    title.textContent = 'Editar Paciente';
    const p = patients.find(x=>x.id===id);
    if(!p) return alert('Paciente no encontrado');
    document.getElementById('f_id').value = p.id;
    document.getElementById('f_document_number').value = p.document_number;
    document.getElementById('f_document_type').value = p.document_type;
    document.getElementById('f_full_name').value = p.full_name;
      document.getElementById('f_height').value = p.height || '';
  document.getElementById('f_weight').value = p.weight || '';
  document.getElementById('f_payment_type').value = p.payment_type || '';
  document.getElementById('f_payment_option').value = p.payment_type || '';
  document.getElementById('f_amount').value = p.amount || '';
  document.getElementById('f_observation').value = p.observation || '';
  }
  openModalId('patientModal');
}

async function savePatient(){
  const id = document.getElementById('f_id').value;
  const payload = {
    document_number: document.getElementById('f_document_number').value.trim(),
    document_type: document.getElementById('f_document_type').value,
    full_name: document.getElementById('f_full_name').value.trim(),
    height: parseFloat(document.getElementById('f_height').value) || null,
    weight: parseFloat(document.getElementById('f_weight').value) || null,
    payment_type: document.getElementById('f_payment_type').value,
    amount: parseFloat(document.getElementById('f_amount').value) || null,
    observation: document.getElementById('f_observation').value.trim()
  };

  if(!payload.document_number || !payload.document_type || !payload.full_name) {
    return alert('Completa los campos requeridos: Documento, Tipo de Documento y Nombre completo.');
  }

  // validaci√≥n unicidad (document_type + document_number) entre activos
  const duplicate = patients.find(p => !p.deleted_at && p.document_type === payload.document_type && p.document_number.toLowerCase() === payload.document_number.toLowerCase() && (id=='' || p.id != Number(id)));
  if(duplicate) {
    return alert('Ya existe un historial activo con este tipo de documento y n√∫mero.');
  }

  if(id){
    // update
    await apiUpdate(Number(id), payload);
    closeModal('patientModal');
    render();
  } else {
    // create
    await apiCreate(payload);
    closeModal('patientModal');
    state.page = 1;
    render();
  }
}

/* ---------- Eliminar (soft delete) ---------- */
function deletePatient(id){
  if(!confirm('¬øSeguro que deseas eliminar este historial?')) return;
  apiDelete(id).then(()=>render());
}

/* ---------- M√°s Info (ventana simple) ---------- */
function openInfo(id){
  const p = patients.find(x=>x.id===id);
  if(!p) return alert('No encontrado');
  
  // reutilizamos modal paciente en modo solo lectura
  openPatientModal('edit', id);
  
  // cambiar t√≠tulo
  document.getElementById('patientModalTitle').textContent = 'Informaci√≥n del Paciente';
  
  // deshabilitar inputs para solo ver
  const inputs = ['f_document_number', 'f_document_type', 'f_full_name', 'f_height', 'f_weight', 'f_payment_type', 'f_payment_option', 'f_amount', 'f_observation'];
  inputs.forEach(inputId => {
    const element = document.getElementById(inputId);
    if(element) {
      if(element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
        element.disabled = true;
      } else {
        element.readOnly = true;
      }
    }
  });

  // deshabilitar bot√≥n guardar
  const saveBtn = document.querySelector('#patientForm .btn-save');
  if(saveBtn) {
    saveBtn.style.display = 'none';
  }
  
  // cambiar texto del bot√≥n cancelar
  const cancelBtn = document.querySelector('#patientForm .btn-ghost');
  if(cancelBtn) {
    cancelBtn.textContent = 'Cerrar';
  }
  
  // cuando se cierra, restauramos
  const restore = ()=> {
    inputs.forEach(inputId => {
      const element = document.getElementById(inputId);
      if(element) {
        if(element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
          element.disabled = false;
        } else {
          element.readOnly = false;
        }
      }
    });
    if(saveBtn) saveBtn.style.display = '';
    if(cancelBtn) cancelBtn.textContent = 'Cancelar';
    document.getElementById('patientModal').removeEventListener('transitionend',restore);
  };
  
  // monitor cuando se cierra el modal
  setTimeout(()=>{
    const observer = new MutationObserver((m)=>{
      const el = document.getElementById('patientModal');
      if(!el.classList.contains('show')) {
        restore();
        observer.disconnect();
      }
    });
    observer.observe(document.getElementById('patientModal'), { attributes:true, attributeFilter:['class'] });
  },0);
}

/* ---------- Historia (ver y agregar entradas) ---------- */
let currentHistoryPatientId = null;
function openHistory(id){
  currentHistoryPatientId = id;
  const p = patients.find(x=>x.id===id);
  if(!p) return alert('Paciente no encontrado');
  document.getElementById('historyPatientName').textContent = `${p.full_name} ‚Äî ${p.document_type}: ${p.document_number}`;
  // limpiar formulario
  document.getElementById('h_date').value = new Date().toISOString().slice(0,10);
  document.getElementById('h_therapist').value = '';
  document.getElementById('h_diagnosis').value = '';
  document.getElementById('h_ailments').value = '';
  document.getElementById('h_medications').value = '';
  document.getElementById('h_observations').value = '';
  document.getElementById('h_height').value = p.height || '';
  document.getElementById('h_weight').value = p.weight || '';
  document.getElementById('h_testimony').value = 'No';
  document.getElementById('h_payment_type').value = p.payment_type || '';
  document.getElementById('h_reflex').value = '';

  renderHistoryList(p);
  openModalId('historyModal');
}

function renderHistoryList(patient){
  const container = document.getElementById('historyList');
  if(!patient.histories || patient.histories.length===0){
    container.innerHTML = `<div style="color:#9c9c9c;padding:6px">Sin entradas previas</div>`;
    return;
  }
  container.innerHTML = '';
  const html = patient.histories.slice().reverse().map(h=>{
    const paymentInfo = h.payment_type ? `<div style="font-size:11px;color:#9a9a9a;margin-top:2px">Pago: ${h.payment_type}</div>` : '';
    return `<div style="padding:8px;border-radius:6px;margin-bottom:8px;background:#0f0f0f;border:1px solid rgba(255,255,255,0.02)">
      <div style="font-size:13px;color:#cfcfcf"><strong>${h.date}</strong> ‚Äî ${h.therapist || '‚Äî'}</div>
      <div style="font-size:12px;color:#bfbfbf;margin-top:6px">${escapeHtml(h.diagnosis||h.observations||'Sin detalles')}</div>
      ${paymentInfo}
    </div>`;
  }).join('');
  container.innerHTML = html;
}

async function saveHistoryEntry(){
  if(!currentHistoryPatientId) return;
  
  const payload = {
    date: document.getElementById('h_date').value,
    therapist: document.getElementById('h_therapist').value.trim(),
    diagnosis: document.getElementById('h_diagnosis').value.trim(),
    ailments: document.getElementById('h_ailments').value.trim(),
    medications: document.getElementById('h_medications').value.trim(),
    observations: document.getElementById('h_observations').value.trim(),
    height: document.getElementById('h_height').value ? parseFloat(document.getElementById('h_height').value) : null,
    weight: document.getElementById('h_weight').value ? parseFloat(document.getElementById('h_weight').value) : null,
    testimony: document.getElementById('h_testimony').value,
    payment_type: document.getElementById('h_payment_type').value,
    reflex: document.getElementById('h_reflex').value.trim(),
    history_id: currentHistoryPatientId
  };

  try {
    // Guardar en la base de datos
    const response = await fetch('/histories_configurations/histories/entries/create/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Error al guardar entrada del historial');
    }

    const savedEntry = await response.json();
    
    // Actualizar en la lista local
    const idx = patients.findIndex(p=>p.id===currentHistoryPatientId);
    if(idx<0) return alert('Paciente no encontrado');
    
    patients[idx].histories = patients[idx].histories || [];
    patients[idx].histories.push(savedEntry);

    // opcionalmente actualizar talla/peso en el paciente
    if(payload.height) patients[idx].height = payload.height;
    if(payload.weight) patients[idx].weight = payload.weight;
    // actualizar tipo de pago en el paciente principal si se especifica
    if(payload.payment_type) patients[idx].payment_type = payload.payment_type;

    renderHistoryList(patients[idx]);
    render(); // para actualizar tabla (si se muestran talla/peso)
    
    // Limpiar formulario
    document.getElementById('h_date').value = new Date().toISOString().slice(0,10);
    document.getElementById('h_therapist').value = '';
    document.getElementById('h_diagnosis').value = '';
    document.getElementById('h_ailments').value = '';
    document.getElementById('h_medications').value = '';
    document.getElementById('h_observations').value = '';
    document.getElementById('h_height').value = '';
    document.getElementById('h_weight').value = '';
    document.getElementById('h_testimony').value = 'No';
    document.getElementById('h_payment_type').value = '';
    document.getElementById('h_reflex').value = '';
    
    alert('Entrada del historial guardada exitosamente en la base de datos.');
    
  } catch (error) {
    console.error('Error al guardar entrada:', error);
    alert('Error al guardar: ' + error.message);
  }
}

/* ---------- Helpers ---------- */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Tab Navigation ---------- */
function initTabs() {
  const navLinks = document.querySelectorAll('.nav-link');
  const tabContents = document.querySelectorAll('.tab-content');
  
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Remove active class from all links and contents
      navLinks.forEach(l => l.classList.remove('active'));
      tabContents.forEach(t => t.classList.remove('active'));
      
      // Add active class to clicked link
      link.classList.add('active');
      
      // Show corresponding content
      const tabId = link.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
      
      // Load data for the active tab
      if (tabId === 'configuraciones') {
        loadConfigurationData();
      }
    });
  });
}

/* ---------- Configuration Data Management ---------- */
let documentTypes = [];
let paymentTypes = [];
let predeterminedPrices = [];

async function loadConfigurationData() {
  try {
    // Cargar datos desde las APIs de Django
    await Promise.all([
      loadDocumentTypes(),
      loadPaymentTypes(),
      loadPredeterminedPrices()
    ]);
    
    // Renderizar las tablas
    renderDocumentTypes();
    renderPaymentTypes();
    renderPredeterminedPrices();
    loadSelectOptions();
  } catch (error) {
    console.error('Error cargando datos de configuraci√≥n:', error);
  }
}

// Funci√≥n para cargar tipos de documento desde la API
async function loadDocumentTypes() {
  try {
    const response = await fetch('/histories_configurations/document_types/');
    if (!response.ok) throw new Error('Error al cargar tipos de documento');
    const data = await response.json();
    documentTypes = data.document_types || [];
  } catch (error) {
    console.error('Error cargando tipos de documento:', error);
    documentTypes = [];
  }
}

function renderDocumentTypes() {
  const tbody = document.getElementById('documentTypesTable');
  tbody.innerHTML = '';
  
  if (documentTypes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#9a9a9a">No hay tipos de documento</td></tr>';
    return;
  }
  
  documentTypes.forEach(type => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(type.name)}</td>
      <td>${escapeHtml(type.description || '')}</td>
      <td class="actions">
        <button class="small-btn edit" onclick="openConfigModal('document_type', 'edit', ${type.id})">Editar</button>
        <button class="small-btn delete" onclick="deleteConfig('document_type', ${type.id})">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Funci√≥n para cargar tipos de pago desde la API
async function loadPaymentTypes() {
  try {
    const response = await fetch('/histories_configurations/payment_types/');
    if (!response.ok) throw new Error('Error al cargar tipos de pago');
    const data = await response.json();
    paymentTypes = data.payment_types || [];
  } catch (error) {
    console.error('Error cargando tipos de pago:', error);
    paymentTypes = [];
  }
}

function renderPaymentTypes() {
  const tbody = document.getElementById('paymentTypesTable');
  tbody.innerHTML = '';
  
  if (paymentTypes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#9a9a9a">No hay tipos de pago</td></tr>';
    return;
  }
  
  paymentTypes.forEach(type => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(type.name)}</td>
      <td>${escapeHtml(type.code || '')}</td>
      <td class="actions">
        <button class="small-btn edit" onclick="openConfigModal('payment_type', 'edit', ${type.id})">Editar</button>
        <button class="small-btn delete" onclick="deleteConfig('payment_type', ${type.id})">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Funci√≥n para cargar precios predeterminados desde la API
async function loadPredeterminedPrices() {
  try {
    const response = await fetch('/histories_configurations/predetermined_prices/');
    if (!response.ok) throw new Error('Error al cargar precios predeterminados');
    const data = await response.json();
    predeterminedPrices = data.predetermined_prices || [];
  } catch (error) {
    console.error('Error cargando precios predeterminados:', error);
    predeterminedPrices = [];
  }
}

function renderPredeterminedPrices() {
  const tbody = document.getElementById('predeterminedPricesTable');
  tbody.innerHTML = '';
  
  if (predeterminedPrices.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#9a9a9a">No hay precios predeterminados</td></tr>';
    return;
  }
  
  predeterminedPrices.forEach(payment => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(payment.name)}</td>
      <td>S/ ${(payment.price || 0).toFixed(2)}</td>
      <td class="actions">
        <button class="small-btn edit" onclick="openConfigModal('predetermined_payment', 'edit', ${payment.id})">Editar</button>
        <button class="small-btn delete" onclick="deleteConfig('predetermined_payment', ${payment.id})">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function loadSelectOptions() {
  // Load document types in patient form
  const docTypeSelect = document.getElementById('f_document_type');
  const hDocTypeSelect = document.getElementById('h_document_type');
  docTypeSelect.innerHTML = '<option value="">Seleccionar...</option>';
  if (hDocTypeSelect) hDocTypeSelect.innerHTML = '<option value="">Seleccionar...</option>';
  
  documentTypes.forEach(type => {
    docTypeSelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
    if (hDocTypeSelect) hDocTypeSelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
  });
  
  // Load payment types in patient form and history form
  const paymentTypeSelects = ['f_payment_type', 'h_payment_type', 'config_payment_type'];
  paymentTypeSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">Seleccionar...</option>';
      paymentTypes.forEach(type => {
        select.innerHTML += `<option value="${type.name}">${type.name}</option>`;
      });
    }
  });

  // Load payment options in patient form
  const paymentOptionSelect = document.getElementById('f_payment_option');
  if (paymentOptionSelect) {
    paymentOptionSelect.innerHTML = '<option value="">Seleccionar opci√≥n...</option>';
    predeterminedPrices.forEach(payment => {
      paymentOptionSelect.innerHTML += `<option value="${payment.name}" data-amount="${payment.price}">${payment.name}</option>`;
    });
  }
}

// Funci√≥n para validar que solo contenga letras, espacios y caracteres especiales v√°lidos
function validateTextInput(input) {
  const value = input.value;
  const regex = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s\-\.]*$/;
  
  if (!regex.test(value)) {
    input.style.borderColor = '#ff4d4f';
    input.title = 'Solo se permiten letras, espacios, guiones y puntos';
    input.classList.add('error');
  } else {
    input.style.borderColor = '';
    input.title = '';
    input.classList.remove('error');
  }
}

// Funci√≥n para validar que solo contenga n√∫meros
function validateNumberInput(input) {
  const value = input.value;
  const regex = /^[0-9\.]*$/;
  
  if (!regex.test(value)) {
    input.style.borderColor = '#ff4d4f';
    input.title = 'Solo se permiten n√∫meros y punto decimal';
    input.classList.add('error');
  } else {
    input.style.borderColor = '';
    input.title = '';
    input.classList.remove('error');
  }
}

/* ---------- Configuration Modal Management ---------- */
function openConfigModal(type, mode, id = null) {
  const modal = document.getElementById('configModal');
  const title = document.getElementById('configModalTitle');
  const form = document.getElementById('configForm');
  const amountField = document.getElementById('amountField');
  const paymentTypeField = document.getElementById('paymentTypeField');
  
  // Reset form
  document.getElementById('config_id').value = '';
  document.getElementById('config_name').value = '';
  document.getElementById('config_description').value = '';
  document.getElementById('config_amount').value = '';
  document.getElementById('config_payment_type').value = '';
  document.getElementById('config_type').value = type;
  
  // Show/hide fields based on type
  if (type === 'predetermined_payment') {
    amountField.style.display = 'block';
    paymentTypeField.style.display = 'none'; // No necesitamos tipo de pago para precios predeterminados
    title.textContent = mode === 'create' ? 'Crear Pago Predeterminado' : 'Editar Pago Predeterminado';
  } else {
    amountField.style.display = 'none';
    paymentTypeField.style.display = 'none';
    title.textContent = mode === 'create' ? `Crear ${type === 'document_type' ? 'Tipo de Documento' : 'Tipo de Pago'}` : `Editar ${type === 'document_type' ? 'Tipo de Documento' : 'Tipo de Pago'}`;
  }
  
  if (mode === 'edit' && id) {
    let item;
    if (type === 'document_type') {
      item = documentTypes.find(t => t.id === id);
      if (item) {
        document.getElementById('config_id').value = item.id;
        document.getElementById('config_name').value = item.name;
        document.getElementById('config_description').value = item.description;
      }
    } else if (type === 'payment_type') {
      item = paymentTypes.find(t => t.id === id);
      if (item) {
        document.getElementById('config_id').value = item.id;
        document.getElementById('config_name').value = item.name;
        document.getElementById('config_description').value = item.description;
      }
    } else if (type === 'predetermined_payment') {
      item = predeterminedPrices.find(p => p.id === id);
      if (item) {
        document.getElementById('config_id').value = item.id;
        document.getElementById('config_name').value = item.name;
        document.getElementById('config_description').value = item.name; // Usamos name como descripci√≥n
        document.getElementById('config_amount').value = item.price || '';
      }
    }
  }
  
  openModalId('configModal');
}

async function saveConfig() {
  const type = document.getElementById('config_type').value;
  const id = document.getElementById('config_id').value;
  const name = document.getElementById('config_name').value.trim();
  const description = document.getElementById('config_description').value.trim();
  
  if (!name) {
    return alert('El nombre es requerido.');
  }
  
  // Validar que el nombre solo contenga letras, espacios y caracteres especiales v√°lidos
  if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s\-\.]+$/.test(name)) {
    return alert('El nombre solo debe contener letras, espacios, guiones y puntos.');
  }
  
  try {
    if (type === 'predetermined_payment') {
      const price = parseFloat(document.getElementById('config_amount').value);
      
      if (!price || price <= 0) {
        return alert('El precio debe ser mayor a 0.');
      }
      
      if (id) {
        // Update
        const response = await fetch(`/histories_configurations/predetermined_prices/${id}/edit/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al actualizar precio predeterminado');
        }
      } else {
        // Create
        const response = await fetch('/histories_configurations/predetermined_prices/create/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al crear precio predeterminado');
        }
      }
      
      // Recargar datos
      await loadPredeterminedPrices();
      renderPredeterminedPrices();
      loadSelectOptions(); // Actualizar opciones en formularios
      
    } else if (type === 'document_type') {
      if (id) {
        // Update
        const response = await fetch(`/histories_configurations/document_types/${id}/edit/`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al actualizar tipo de documento');
        }
      } else {
        // Create
        const response = await fetch('/histories_configurations/document_types/create/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al crear tipo de documento');
        }
      }
      
      // Recargar datos
      await loadDocumentTypes();
      renderDocumentTypes();
      loadSelectOptions();
      
    } else if (type === 'payment_type') {
      if (id) {
        // Update
        const response = await fetch(`/histories_configurations/payment_types/${id}/edit/`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, code: description })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al actualizar tipo de pago');
        }
      } else {
        // Create
        const response = await fetch('/histories_configurations/payment_types/create/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, code: description })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al crear tipo de pago');
        }
      }
      
      // Recargar datos
      await loadPaymentTypes();
      renderPaymentTypes();
      loadSelectOptions();
    }
    
    closeModal('configModal');
    
  } catch (error) {
    console.error('Error al guardar configuraci√≥n:', error);
    alert('Error: ' + error.message);
  }
}

async function deleteConfig(type, id) {
  if (!confirm('¬øSeguro que deseas eliminar este elemento?')) return;
  
  try {
    if (type === 'document_type') {
      const response = await fetch(`/histories_configurations/document_types/${id}/delete/`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Error al eliminar tipo de documento');
      }
      
      // Recargar datos
      await loadDocumentTypes();
      renderDocumentTypes();
      loadSelectOptions();
      
    } else if (type === 'payment_type') {
      const response = await fetch(`/histories_configurations/payment_types/${id}/delete/`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Error al eliminar tipo de pago');
      }
      
      // Recargar datos
      await loadPaymentTypes();
      renderPaymentTypes();
      loadSelectOptions();
      
    } else if (type === 'predetermined_payment') {
      const response = await fetch(`/histories_configurations/predetermined_prices/${id}/delete/`, {
        method: 'POST'
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Error al eliminar precio predeterminado');
      }
      
      // Recargar datos
      await loadPredeterminedPrices();
      renderPredeterminedPrices();
    }
    
  } catch (error) {
    console.error('Error al eliminar configuraci√≥n:', error);
    alert('Error: ' + error.message);
  }
}

// Funci√≥n para actualizar autom√°ticamente el monto seg√∫n la opci√≥n de pago seleccionada
function updateAmountFromOption() {
  const paymentOptionSelect = document.getElementById('f_payment_option');
  const amountInput = document.getElementById('f_amount');
  
  if (paymentOptionSelect && amountInput) {
    const selectedOption = paymentOptionSelect.value;
    if (selectedOption) {
      // Buscar el pago predeterminado seleccionado
      const selectedPayment = predeterminedPrices.find(p => p.name === selectedOption);
      if (selectedPayment) {
        // Solo actualizar el monto, NO el tipo de pago
        amountInput.value = selectedPayment.price || 0;
      }
    }
  }
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', async ()=> {
  render();
  initTabs();
  
  // Cargar datos de configuraci√≥n al inicio
  try {
    await Promise.all([
      loadDocumentTypes(),
      loadPaymentTypes(),
      loadPredeterminedPrices()
    ]);
    loadSelectOptions();
  } catch (error) {
    console.error('Error cargando datos iniciales:', error);
  }
  
  // opcional: cambiar page size seg√∫n pantalla
  if(window.innerWidth < 600) state.pageSize = 6;
});
</script>

</body>
</html>
